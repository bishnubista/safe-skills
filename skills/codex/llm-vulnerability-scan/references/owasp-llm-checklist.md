# OWASP LLM Vulnerability Detection Checklist

> This file is loaded by scan workers on demand. Each worker reads only its relevant section.

## Severity Criteria

| Severity | Criteria |
|----------|----------|
| **Critical** | Direct code execution; prompt injection with no sanitization; exposed secrets in prompts; RCE vectors |
| **High** | Excessive permissions; missing output validation before DB/shell; unverified supply chain; sandbox escape |
| **Medium** | Missing rate limits; broad tool access; no access partitioning; missing integrity checks |
| **Low** | Missing monitoring; no source attribution; incomplete error handling; no behavioral tracking |
| **Info** | Best practice recommendations; defense-in-depth suggestions |

---

## Worker 1: Injection & Prompt Security

### LLM01 — Prompt Injection
**SAFE-MCP:** SAFE-T1102, SAFE-T1110, SAFE-T1401, SAFE-T1402
**Mitigations:** SAFE-M-1, SAFE-M-4, SAFE-M-5, SAFE-M-39

**Detection Patterns:**

1. **String interpolation in prompts** (Critical)
   - Pattern: Template literals or f-strings containing user input concatenated into prompts
   - Look for: `${userInput}`, `{user_input}`, `+ userInput +`, `f"...{input}..."`
   - Files: Any file importing OpenAI/Anthropic/LLM SDKs
   - Remediation: Use parameterized prompt templates; separate system and user message roles

2. **Missing input sanitization** (High)
   - Pattern: User input passed directly to LLM API without validation
   - Look for: Request body/query params flowing into `messages` array without sanitization
   - Remediation: Validate and sanitize all user input; implement input length limits

3. **No role separation** (High)
   - Pattern: Single message combining system instructions and user input
   - Look for: System prompt and user content in same `content` field
   - Remediation: Use separate `system` and `user` message roles

4. **Indirect injection via external data** (High)
   - Pattern: External data (URLs, files, DB results) included in prompts without sanitization
   - Look for: `fetch()` or file read results inserted into prompt context
   - Remediation: Sanitize external data; use content boundaries; implement output filtering

### LLM07 — System Prompt Leakage
**SAFE-MCP:** SAFE-T1603, SAFE-T1805
**Mitigations:** SAFE-M-21, SAFE-M-39

**Detection Patterns:**

1. **Secrets in system prompts** (Critical)
   - Pattern: API keys, tokens, passwords hardcoded in system prompt strings
   - Look for: `sk-`, `ghp_`, `Bearer`, `password`, `secret`, `token` in prompt content
   - Remediation: Move all secrets to environment variables; never include in prompts

2. **Sensitive business logic in prompts** (Medium)
   - Pattern: Pricing formulas, internal rules, proprietary algorithms in system prompts
   - Look for: Internal documentation, business rules in prompt strings
   - Remediation: Keep prompts as simple behavioral instructions; store logic in code

3. **No prompt isolation** (Medium)
   - Pattern: System prompt content accessible through conversation API responses
   - Look for: System prompt returned in API responses or logged without redaction
   - Remediation: Implement output filtering; never echo system prompt back to users

### ASI01 — Agent Goal Hijack
**SAFE-MCP:** SAFE-T1001, SAFE-T1008
**Mitigations:** SAFE-M-1, SAFE-M-2, SAFE-M-22

**Detection Patterns:**

1. **External data influencing agent goals** (High)
   - Pattern: Tool outputs or external content used to modify agent instructions
   - Look for: Dynamic system prompts constructed from external sources
   - Remediation: Use immutable instruction boundaries; validate all goal-modifying inputs

2. **Tool description manipulation** (High)
   - Pattern: MCP tool descriptions loaded from untrusted sources
   - Look for: Tool definitions fetched at runtime; dynamic tool descriptions
   - Remediation: Pin tool descriptions; use cryptographic integrity verification (SAFE-M-2)

---

## Worker 2: Data Protection & Supply Chain

### LLM02 — Sensitive Information Disclosure
**SAFE-MCP:** SAFE-T1502, SAFE-T1503, SAFE-T1505
**Mitigations:** SAFE-M-21, SAFE-M-22, SAFE-M-37

**Detection Patterns:**

1. **Credentials in prompts or context** (Critical)
   - Pattern: API keys, tokens, or passwords included in LLM context
   - Look for: Environment variables dumped into prompts; `.env` contents in context
   - Remediation: Strip credentials before passing context to LLM

2. **PII in training/fine-tuning data** (High)
   - Pattern: Personal data in datasets used for fine-tuning or RAG
   - Look for: JSONL/CSV data files with email, phone, SSN patterns
   - Remediation: Anonymize PII; implement data classification

3. **Missing output filtering** (High)
   - Pattern: LLM responses returned to users without PII/secret scanning
   - Look for: Raw LLM response passed directly to client
   - Remediation: Implement output scanning for secrets and PII patterns

4. **Environment variable exposure** (Critical)
   - Pattern: `process.env` or `os.environ` contents passed to LLM
   - Look for: `process.env` / `os.environ` / `os.getenv` in prompt construction
   - Remediation: Allowlist specific env vars; never pass env object to LLM

### LLM03 — Supply Chain
**SAFE-MCP:** SAFE-T1002, SAFE-T1003, SAFE-T1207
**Mitigations:** SAFE-M-6, SAFE-M-24, SAFE-M-41

**Detection Patterns:**

1. **Unverified model sources** (High)
   - Pattern: Models loaded from URLs or registries without integrity verification
   - Look for: `from_pretrained()` without hash verification; model URLs without checksums
   - Remediation: Pin model versions; verify checksums; use trusted registries

2. **Missing dependency integrity** (Medium)
   - Pattern: LLM-related packages installed without lockfile or integrity checks
   - Look for: Missing `package-lock.json`, `poetry.lock`; unpinned AI dependencies
   - Remediation: Pin all AI/ML dependencies; maintain lockfiles

### LLM04 — Data & Model Poisoning
**SAFE-MCP:** SAFE-T1204, SAFE-T2107
**Mitigations:** SAFE-M-26, SAFE-M-33, SAFE-M-34

**Detection Patterns:**

1. **Unvalidated RAG data sources** (High)
   - Pattern: External data ingested into RAG without validation
   - Look for: Web scraping results, user-uploaded files indexed directly
   - Remediation: Validate and sanitize data before RAG ingestion; track data provenance

2. **No data provenance tracking** (Medium)
   - Pattern: Training or fine-tuning data without source documentation
   - Look for: Data loading without provenance metadata
   - Remediation: Implement data provenance tracking (SAFE-M-26)

### ASI04 — Agentic Supply Chain
**SAFE-MCP:** SAFE-T1004, SAFE-T1006, SAFE-T1009
**Mitigations:** SAFE-M-6, SAFE-M-14, SAFE-M-45

**Detection Patterns:**

1. **Untrusted MCP servers** (High)
   - Pattern: MCP server configs pointing to unverified endpoints
   - Look for: `.mcp.json` or `mcp` config with arbitrary URLs; no allowlisting
   - Remediation: Maintain server allowlist (SAFE-M-14); verify server attestation

2. **Unverified tool definitions** (High)
   - Pattern: MCP tool schemas loaded without integrity checks
   - Look for: Dynamic tool loading from remote sources
   - Remediation: Pin tool versions; sign tool manifests (SAFE-M-45)

---

## Worker 3: Output, Agency & Tool Safety

### LLM05 — Improper Output Handling
**SAFE-MCP:** SAFE-T1101, SAFE-T1105
**Mitigations:** SAFE-M-5, SAFE-M-21, SAFE-M-22

**Detection Patterns:**

1. **LLM output to eval/exec** (Critical)
   - Pattern: LLM response passed to code execution functions
   - Look for: `eval(`, `exec(`, `subprocess`, `child_process`, `Function(` with LLM output
   - Remediation: Never execute LLM output directly; use sandboxed interpreters

2. **LLM output to SQL** (Critical)
   - Pattern: LLM-generated text used in database queries without parameterization
   - Look for: String concatenation in SQL with LLM response; `query(llmResponse)`
   - Remediation: Use parameterized queries; validate SQL structure before execution

3. **LLM output to shell** (Critical)
   - Pattern: LLM response passed to shell execution
   - Look for: `execSync(`, `os.system(`, `subprocess.run(` with LLM output
   - Remediation: Never pass LLM output to shell; use structured commands with allowlists

4. **Unsanitized HTML rendering** (High)
   - Pattern: LLM output rendered as HTML without sanitization
   - Look for: `innerHTML`, `dangerouslySetInnerHTML`, `v-html` with LLM content
   - Remediation: Sanitize HTML output; use text-only rendering where possible

5. **Path traversal** (High)
   - Pattern: LLM output used in file paths without validation
   - Look for: `readFile(llmOutput)`, `open(llm_response)` without path validation
   - Remediation: Validate and sanitize file paths; use allowlisted directories

### LLM06 — Excessive Agency
**SAFE-MCP:** SAFE-T1104, SAFE-T1106, SAFE-T1302
**Mitigations:** SAFE-M-29, SAFE-M-11

**Detection Patterns:**

1. **Overly broad tool permissions** (High)
   - Pattern: Agent tools with unrestricted file, network, or system access
   - Look for: Tool definitions with `*` permissions; no scope restrictions
   - Remediation: Apply least-privilege; restrict tools to specific directories/APIs

2. **Missing human-in-the-loop** (High)
   - Pattern: Destructive actions (delete, send, execute) without approval step
   - Look for: Delete/write/send operations without confirmation prompts
   - Remediation: Require human approval for high-impact operations

3. **Autonomous loops without limits** (Medium)
   - Pattern: Agent loops without iteration caps or timeout
   - Look for: `while` loops in agent code without max iteration; no timeout
   - Remediation: Implement iteration limits and timeouts on agent loops

### ASI02 — Tool Misuse & Exploitation
**SAFE-MCP:** SAFE-T1103, SAFE-T1109, SAFE-T1205
**Mitigations:** SAFE-M-38, SAFE-M-11, SAFE-M-29

**Detection Patterns:**

1. **No schema validation on tool inputs** (High)
   - Pattern: Tool calls accepted without input validation
   - Look for: Tool handlers without parameter validation; missing JSON schema
   - Remediation: Define strict JSON schemas for all tool inputs; validate before execution

2. **Overly permissive tool definitions** (Medium)
   - Pattern: Tools with broader capabilities than needed
   - Look for: Generic file/network/exec tools without scope restrictions
   - Remediation: Create purpose-specific tools with minimal capabilities

### ASI05 — Unexpected Code Execution (RCE)
**SAFE-MCP:** SAFE-T1111, SAFE-T1303, SAFE-T1305
**Mitigations:** SAFE-M-9, SAFE-M-10

**Detection Patterns:**

1. **LLM-generated code without sandbox** (Critical)
   - Pattern: Code generated by LLM executed in main process
   - Look for: `eval(`, `exec(`, code interpreters without isolation
   - Remediation: Execute all LLM-generated code in sandboxed environments

2. **Network access from code execution** (High)
   - Pattern: Code execution environments with unrestricted network
   - Look for: Code interpreters without network restrictions
   - Remediation: Disable network access in code execution sandboxes

---

## Worker 4: Identity, Memory & RAG

### LLM08 — Vector & Embedding Weaknesses
**SAFE-MCP:** SAFE-T2106
**Mitigations:** SAFE-M-30, SAFE-M-32

**Detection Patterns:**

1. **Misconfigured vector DB access** (High)
   - Pattern: Vector database without authentication or access controls
   - Look for: Connection strings without auth; public vector DB endpoints
   - Remediation: Enable authentication; implement access partitioning

2. **No data isolation in vector stores** (Medium)
   - Pattern: Multi-tenant data in single vector collection without filtering
   - Look for: Shared collections without tenant-based filtering
   - Remediation: Implement logical partitioning or separate collections per tenant

### ASI03 — Identity & Privilege Abuse
**SAFE-MCP:** SAFE-T1304, SAFE-T1306, SAFE-T1308, SAFE-T1202, SAFE-T1206
**Mitigations:** SAFE-M-16, SAFE-M-29

**Detection Patterns:**

1. **Long-lived API tokens** (High)
   - Pattern: Static API keys or tokens without expiration
   - Look for: Hardcoded tokens; no token rotation; missing expiry configuration
   - Remediation: Use short-lived, session-based credentials; implement token rotation

2. **Excessive credential inheritance** (High)
   - Pattern: Agent inherits all permissions from parent process
   - Look for: Agent using same credentials as application; no scoped tokens
   - Remediation: Create dedicated agent credentials with minimal scope

3. **Credentials in config files** (Critical)
   - Pattern: Secrets stored in MCP or agent configuration files
   - Look for: API keys in `.mcp.json`, `settings.json`, `CLAUDE.md`
   - Remediation: Use environment variables or secret managers

### ASI06 — Memory & Context Poisoning
**SAFE-MCP:** SAFE-T1204, SAFE-T1702, SAFE-T2106
**Mitigations:** SAFE-M-30, SAFE-M-32, SAFE-M-26

**Detection Patterns:**

1. **Unvalidated persistent memory** (High)
   - Pattern: Agent memory/context stored without integrity verification
   - Look for: Vector store writes without validation; memory updates from untrusted sources
   - Remediation: Implement integrity checks on memory writes; validate data sources

2. **No version control on knowledge stores** (Medium)
   - Pattern: RAG knowledge base without change tracking
   - Look for: Direct writes to vector stores without audit trail
   - Remediation: Version knowledge base updates; enable rollback capability

---

## Worker 5: Reliability & Trust

### LLM09 — Misinformation
**SAFE-MCP:** SAFE-T2105, SAFE-T1404
**Mitigations:** SAFE-M-22

**Detection Patterns:**

1. **No output verification for critical decisions** (Medium)
   - Pattern: LLM output used for decisions without fact-checking
   - Look for: LLM responses driving business logic without validation
   - Remediation: Implement verification for critical outputs; require human review

2. **Hallucinated package names** (High)
   - Pattern: LLM-suggested dependencies installed without verification
   - Look for: Automated `npm install` or `pip install` from LLM output
   - Remediation: Verify package existence and safety before installation

### LLM10 — Unbounded Consumption
**SAFE-MCP:** SAFE-T1106, SAFE-T2102
**Mitigations:** SAFE-M-11, SAFE-M-23

**Detection Patterns:**

1. **No rate limiting on LLM API calls** (Medium)
   - Pattern: LLM API calls without rate limiting or throttling
   - Look for: API calls in loops without rate limits; no retry backoff
   - Remediation: Implement rate limiting, exponential backoff, and cost budgets

2. **Missing token/cost limits** (Medium)
   - Pattern: No `max_tokens` or cost controls on LLM API calls
   - Look for: API calls without `max_tokens` parameter; no cost tracking
   - Remediation: Set `max_tokens`; implement cost monitoring and alerts

3. **Unbounded retry loops** (Medium)
   - Pattern: Retry logic without maximum attempts
   - Look for: Retry loops without `maxRetries`; no circuit breaker
   - Remediation: Set max retries; implement circuit breaker pattern

### ASI07 — Insecure Inter-Agent Communication
**SAFE-MCP:** SAFE-T1705, SAFE-T1701, SAFE-T1904
**Mitigations:** SAFE-M-42

**Detection Patterns:**

1. **Unvalidated inter-agent messages** (Medium)
   - Pattern: Agents accepting instructions from other agents without validation
   - Look for: Agent-to-agent message passing without authentication
   - Remediation: Validate source identity; implement message signing

### ASI08 — Cascading Failures
**SAFE-MCP:** SAFE-T2102, SAFE-T1106
**Mitigations:** SAFE-M-11

**Detection Patterns:**

1. **Missing circuit breakers** (Medium)
   - Pattern: Sequential tool calls without failure isolation
   - Look for: Chained operations without error boundaries; no fallback logic
   - Remediation: Implement circuit breakers; define safe failure modes

2. **No transactional rollback** (Medium)
   - Pattern: Multi-step agent operations without rollback on failure
   - Look for: Multi-step writes without compensation logic
   - Remediation: Implement compensating transactions; track state for rollback

### ASI09 — Human-Agent Trust Exploitation
**SAFE-MCP:** SAFE-T1403, SAFE-T1404
**Mitigations:** SAFE-M-40

**Detection Patterns:**

1. **No decision transparency** (Low)
   - Pattern: Agent makes decisions without explaining reasoning
   - Look for: Actions taken without logging rationale; no audit trail
   - Remediation: Log agent reasoning; require source attribution for claims

### ASI10 — Rogue Agents
**SAFE-MCP:** SAFE-T1106
**Mitigations:** SAFE-M-11

**Detection Patterns:**

1. **No behavioral monitoring** (Low)
   - Pattern: Agent operates without observation or drift detection
   - Look for: Missing logging; no behavioral baselines; no anomaly detection
   - Remediation: Implement behavioral monitoring; set up anomaly alerting

2. **Missing kill switch** (Low)
   - Pattern: No mechanism to halt agent operation immediately
   - Look for: No timeout; no shutdown command; no admin override
   - Remediation: Implement non-negotiable kill switch; set operation timeouts
